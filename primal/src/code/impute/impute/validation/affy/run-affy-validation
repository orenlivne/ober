#!/bin/bash
#---------------------------------------------------------
# Prepare non-QCed Affy imputation validation data set.
#---------------------------------------------------------

#----------------------
# Constants
#----------------------
# PLINK data set of union of the 3 Affy chip SNPs of interest (passed QC, have a wider MAF range but no singletons)
AFFY="${OBER_DATA}/hutt-affy-union/hutt.3chips.qc-maf-0.01"
# Downsampled data set (to fit imputation run in memory since our program loads all SNPs, unfortunately)
# Output directory of data files generated by the run
OUT_DIR="${OBER_OUT}/validation/affy"
AFFY_SAMPLE="${OUT_DIR}/hutt.3chips.qc-maf-0.01.sample"
# Directory to output plots and statistics to
DOC_DIR=${OBER}/doc/imputation/validation/affy

#----------------------
# Read input arguments
#----------------------
DARGS=65
PROGNAME=`basename $0`

if [ $# -ne 1 ]; then
  echo "Usage: ${PROGNAME} <downsample-factor>"
  echo ""
  echo "Prepare non-QCed Affy imputation validation data set."
  echo "Downsample by the specified factor."
  exit $E_BADARGS
fi
# Downsampling factor to make validation tractable given memory limitation (in principle, there
# should not be one, since we should be imputing one SNP at a time, but the current implementation
# doesn't support that).
downsampling_factor="$1" # a value of 10 fits in memory

#----------------
# Constants
#----------------

#----------------
# Main Program
#----------------
mkdir -p ${OUT_DIR} ${DOC_DIR} 
cd ${OUT_DIR}

# Restrict to 3-chip intersection (using high call rate threshold)
# Downsample to a manageable data set size; restrict to autosomal SNPs; convert to TPED format
if [ ! -f ${AFFY_SAMPLE}.tped ]; then
    awk '$1 <= 22' ${AFFY}.bim | awk -v f="${downsampling_factor}" '{ if (!(NR % f)) { print $2; } }' > ${AFFY_SAMPLE}.snp
    plink --noweb --bfile ${AFFY} --out ${AFFY_SAMPLE} --geno 0.02 --extract ${AFFY_SAMPLE}.snp --recode12 --transpose
fi

# Run analysis
python ${OBER_CODE}/impute/impute/validation/affy/run_affy_validation.py ${AFFY_SAMPLE} ${DOC_DIR}
